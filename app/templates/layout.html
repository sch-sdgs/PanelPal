<!DOCTYPE html>
<html>
<head>
    <title>PanelPal</title>
    <link rel="shortcut icon" href="/favicon.ico}" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>
    <!--<script src="/static/js/bootstrap.min.js"></script>-->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.0/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>

    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <!--<link rel="stylesheet" href="/static/css/bootstrap-theme.min.css">-->
    <link rel="stylesheet" href="/static/css/panel_pal.css">

    <!-- Latest compiled JavaScript -->
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">

    <script>
        function region_added(){
            $('#complete_message').removeClass('alert-danger').addClass('alert-success');
            $('#complete_message').html('<strong>Congratulations!</strong> You have completed your virtual panel');
            $('#cancel').removeClass('btn-danger').addClass('btn-success');
            $('#cancel').text('Done!');
            $('#cancel').attr('type', 'submit');
            $('#cancel_logo').removeClass('fa-remove').addClass('fa-check');
            $('#make_live').removeAttr('hidden')
        }
    </script>

    <script>
        function remove_vp(vp_name)
        {
            var dict = {
                        "vp_name": vp_name
                        };
            var data=JSON.stringify(dict);

            $.ajax({
                type: "POST",
                url: "{{url_for('remove_vp')}}",
                data: data,
                dataType: "json",
                contentType: "application/json",
                success: function (response) {
                    window.location.replace("{{url_for('create_virtual_panel_process')}}");
                },
                error: function (response) {
                    console.log($(response).responseText);
                    console.log('Error');
                    return false;
                }
            })
        }

        $(document).on('click', '#cancel', function(){
            var vp_name = $('#vpanelname').val();
            if($('#cancel').hasClass('btn-danger'))
            {
                remove_vp(vp_name)
            }
        });
    </script>

    <script>
        function add_vp(changeTab, e){
            var vp_name = $('#vpanelname').val();
            var panel_id = $('#panel').val();
            var dict = {
                        "vp_name": vp_name,
                        "panel_id": panel_id
                        };
            var data=JSON.stringify(dict);
            var complete = false;
            $.when($.ajax({
                type:"POST",
                url:"{{url_for('add_vp')}}",
                data:data,
                dataType:"json",
                contentType:"application/json",
                success:function(response){
                    if(response == -1 && $('#vpanelname').val().length ==0)
                    {
                        var new_html = "<div class=\"alert alert-danger\"><strong>Silly Sausage!</strong> You haven't added a panel name</div>";
                        $('#message').append(new_html)

                    }
                    else if (response == -1)
                    {
                        var new_html = "<div class=\"alert alert-danger\"><strong>Silly Sausage!</strong> That name isn't unique</div>";
                        $('#message').append(new_html)
                    }
                    else
                    {
                        var newUrl = "{{url_for('create_virtual_panel_process') }}?id=" + response;
                        $('#main').attr('name', response);
                        $('#main').attr('action', newUrl)
                        $('.glyphicon-list-alt').attr('href', '#select_genes');
                        $('.glyphicon-th-large').attr('href', '#select_regions');
                        $('.glyphicon-ok').attr('href', '#submit_vp');
                        $("#vpanelname").attr("disabled", "disabled");
                        $("#panel").attr("disabled", "disabled");
                        $('.glyphicon.glyphicon-new-selected').removeClass('glyphicon-new-selected').addClass('glyphicon-new');

                        complete = true;

                        if(changeTab == 'next' || changeTab == 'back')
                        {
                            change_tab(changeTab)
                        }
                        else
                        {
                            $("#" + e ).removeClass('glyphicon-new').addClass('glyphicon-new-selected').blur();
                            $("#" + e ).tab('show');
                        }
                    }
                },
                error: function(response){
                    console.log($(response).responseText);
                    console.log('Error');
                    return false;
                }
            })).done(function(){
                return complete;
            });

        }

        $(document).on('click', '.glyphicon', function (j) {

            $('#message').children().remove();

            if($('.glyphicon-new-selected').attr('href') == '#initialise' && $("#vpanelname").attr("disabled") != "disabled")
            {
                add_vp(false, $(j.target).attr('id'));
            }
            else if ($(j.target).hasClass('glyphicon-new') || $(j.target).hasClass('glyphicon-new-selected') ) {
                $('.glyphicon.glyphicon-new-selected').removeClass('glyphicon-new-selected').addClass('glyphicon-new');
                $(this).addClass('glyphicon-new-selected').removeClass('glyphicon-new').blur();
            }
        });
    </script>

    <script>
        function change_tab(tabChange)
        {
            var activeTab = $('.tab-pane.active');
            if (tabChange == 'next') {
                var nextTab = activeTab.next('.tab-pane').attr('id');
                $('[href="#' + nextTab + '"]').addClass('glyphicon-new-selected').removeClass('glyphicon-new');
                $('[href="#' + nextTab + '"]').tab('show');
            }
            else {
                var prevTab = activeTab.prev('.tab-pane').attr('id');
                $('[href="#' + prevTab + '"]').addClass('glyphicon-new-selected').removeClass('glyphicon-new');
                $('[href="#' + prevTab + '"]').tab('show');
            }
        }

        $(document).on('click', '.next-step, .prev-step', function (e) {
            var activeTab = $('.tab-pane.active');
            $('#message').children().remove();
            var tab = 'back';
            var target;
            if($(e.target).is("button"))
            {
                target = $(e.target)
            }
            else
            {
                target = $(e.target).parent()
            }
            if($(target).hasClass('next-step'))
            {
                tab = 'next'
            }
            if($(activeTab).attr('id') == "initialise" && $("#vpanelname").attr("disabled") != "disabled")
            {
                if($('#panel').val() == '__None' || $('#vpanelname').val().length == 0)
                {
                    var new_html = "<div class=\"alert alert-danger\"><strong>Silly Sausage!</strong> You haven't added a panel name</div>";
                    $('#message').append(new_html);
                }
                else
                {
                    add_vp(tab, $(e))
                }
            }
            else {
                $('.glyphicon.glyphicon-new-selected').removeClass('glyphicon-new-selected').addClass('glyphicon-new');

                change_tab(tab)
            }
        });
    </script>

    <script>
        $(document).on('change', '#panel', function(e){
            $('#geneselector').children().remove();
            $('#loading').append("<div class=\"col-md-5\"></div><div class=\"loader col-md-2\"></div><div class=\"col-md-5\"></div>");

            var panel_id = $('#panel').val();
            var dict = {
                        "panel": panel_id
                        };
            var data=JSON.stringify(dict);

            $.ajax({
                type:"POST",
                url:"{{url_for('select_vp_genes')}}",
                data:data,
                dataType:"json",
                contentType:"application/json",
                success:function(response){
                    $('#loading').children().remove();
                    $('#geneselector').append(response)
                },
                error: function(response){
                    console.log($(response).responseText);
                    console.log('Error');}

                });
        });
    </script>

    <script>
        $(document).on('click', '.label-gene', function () {
            var target = $(event.target);
            var gene_switch;
            if($(target).is("button"))
            {
                var geneName = $(target).attr('name');
                $('.label-gene').each(function (i, obj) {
                    if($(obj).attr('for') == geneName)
                    {
                        gene_switch = $(obj);
                        return false;
                    }
                });
                //var gene_switch = $('[for="' + geneName +'"]')
            }
            else {
                var geneName = $(event.target).attr('for');
                gene_switch = $(event.target)
            }

            if($(gene_switch).attr('disabled') != 'disabled') {
                if ($(gene_switch).attr('checked') == 'checked')//uncheck and remove gene button
                {
                    $(gene_switch).removeAttr('checked');
                    $('[name="genebutton"]').each(function (i, obj) {
                        if ($(obj).attr('data-name') == geneName) {
                            $(obj).remove();
                            if ($('#remove-gene').attr('name') == geneName) {
                                $('#regions').children().remove();
                            }
                            return false;
                        }
                    })
                }
                else {
                    $(event.target).attr('checked', 'checked');
                    var geneId = $("#" + geneName).attr('name');
                    $('#genelist').append("<button name=\"genebutton\" type=\"button\" class=\"btn btn-danger btn-md btngene\" data-name=\"" + geneName + "\" data-id=\"" + geneId + "\"><span class='glyphicon glyphicon-pencil'></span> " + geneName + "</button> ")
                }
            }
        });
    </script>

    <script>
        $(document).on('click', '[name="genebutton"]', function (request) {
            $('#regions').children().remove();
            if($(request.currentTarget).hasClass('btn-danger')) {
                var element = $(request.currentTarget);
                var gene_id = $(element).attr('data-id');
                var gene_name = $(element).attr('data-name');
                var panel_id = $('#panel').val();
                var dict = {
                    "panel_id": panel_id,
                    "gene_id": gene_id,
                    "gene_name": gene_name
                };
                var data = JSON.stringify(dict);

                $.ajax({
                    type: "POST",
                    url: "{{url_for('select_vp_regions')}}",
                    data: data,
                    dataType: "json",
                    contentType: "application/json",
                    success: function (response) {
                        $('#regions').children().remove();
                        $('#regions').append(response)
                    },
                    error: function (response) {
                        console.log($(response).responseText);
                        console.log('Error');
                    }

                });
            }
            else
            {
                $('#regions').append("<h3>You have already added this gene to the database</h3><h4>To change the regions go to the edit page for this virtual panel</h4>")
            }
            });


    </script>

    <script>
        function count_ids(){
            var ids = [];
            $('.label-region').each(function (i, obj) {
                if($(obj).attr('checked') == 'checked')
                {
                    ids.push($(obj).attr('for'));
                }
            });
            return ids
        }

        $(document).on('click', ".label-region", function (request) {
            var obj = $(request.currentTarget);
            if($(obj).attr('checked') == 'checked')
            {
                $(obj).removeAttr('checked');
                if($(".label-selectall").attr('checked') == 'checked')
                {
                    $(".label-selectall").attr('uncheck-all', 'false');
                    $(".label-selectall").trigger('click')
                }
            }
            else
            {
                $(obj).attr('checked', 'checked')
            }

            var count = count_ids().length;
            if(count > 0)
            {
                $('#add-regions').removeAttr('disabled');
            }
            else if($('#add-regions').attr('disabled') != 'disabled')
            {
                $('#add-regions').attr('disabled', 'disabled');
            }
        });
    </script>

    <script>

        $(document).on('click', ".label-selectall", function () {

            if ($(".label-selectall").attr('uncheck-all') == 'false')//if one
            {
                $(".label-selectall").removeAttr('checked');
                $(".label-selectall").removeAttr('uncheck-all')
            }
            else if ($(".label-selectall").attr('checked') == 'checked') //if select all has been clicked off
            {
                $(".label-selectall").removeAttr('checked'); //remove the checked attribute

                $(".label-region").each(function(i, obj)//loop through all elements with .label-region class
                {
                    if ($(obj).attr('checked') == 'checked')//if object is checked turn it off
                    {
                        $(obj).trigger('click');
                    }
                });
            }
            else //if select all has been clicked on
            {
                $(".label-selectall").attr('checked', 'checked');//add checked attribute

                $(".label-region").each(function(i, obj)//loop through all elements with .label-region class
                {
                    if ($(obj).attr('checked') != 'checked')//if object is selected do nothing
                    {
                        $(obj).trigger('click')
                    }
                });

            }

        });
    </script>

    <script>
        $(document).on('click', "#remove-gene", function () {
            var geneName = $('#remove-gene').attr('name');
            $('.label-gene').each(function (i, obj) {
                    if ($(obj).attr('for') == geneName)
                    {
                        $(obj).trigger('click');
                        return false;
                    }
                });
            $('#regions').children().remove();
        });
    </script>

    <script>
        $(document).on('click', "#add-regions", function () {
            var geneName = $('#add-regions').attr('name');
            var ids = count_ids();
            var vpanel_id = $('#main').attr('name');

            if(ids.length == 0)
            {
                console.log('none selected');
                return;
            }

            var dict = {
                "vp_id": vpanel_id,
                "ids": ids
            };
            var data=JSON.stringify(dict);
            $.ajax({
                type:"POST",
                url:"{{url_for('add_vp_regions')}}",
                data:data,
                dataType:"json",
                contentType:"application/json",
                success:function(){
                    $('[name="genebutton"]').each(function (i, obj) {
                        if($(obj).attr('data-name') == geneName)
                        {
                            $(obj).children('.glyphicon-pencil').removeClass('glyphicon-pencil').addClass('glyphicon-ok').blur();
                            $(obj).removeClass('btn-danger').addClass('btn-success').blur();
                        }
                    });
                    $('#regions').children().remove();

                    $('#'+geneName).attr('disabled', 'disabled');
                    $('[for='+geneName+']').attr('disabled', 'disabled');
                    $('[for='+geneName+']').removeClass('label-success').addClass('label-added');

                    if($('#cancel').hasClass('btn-danger'))
                    {
                        region_added();
                    }
                },
                error: function(response){
                    console.log($(response));
                    console.log('Error');}

                });
        });
    </script>

    <script>

        $(document).ready(function () {

            $('[data-toggle="tooltip"]').tooltip();

            $("#genelabels").hide();

            // Add items to input field
            var eachline = '';
            $("#add").click(function () {

                $("#genelabels").show();
                var lines = $('#genes').val().split('\n');
                var lines2 = $('#listgenes').val().split('\n');

                for (var i = 0; i < lines.length; i++) {
                    if (lines[i] != '' && i + lines2.length < 11) {
                        eachline += lines[i] + '\n';
                    }
                }

                $("<h3><span class='label label-warning test'>" + lines + "</span></h3>").appendTo('#addhere');

                var TheTextBox = document.getElementById("listgenes");
                TheTextBox.value = TheTextBox.value + lines + ",";

                $('#genes').val('');
            });
        });
    </script>
    <script>
        $(function () {
            $("#genes").autocomplete({
                source: function (request, response) {
                    $.getJSON("{{url_for('autocomplete')}}", {
                        q: request.term, // in flask, "q" will be the argument to look for using request.args
                    }, function (data) {
                        response(data.matching_results); // matching_results from jsonify
                    });
                },
                minLength: 2,
                select: function (event, ui) {
                    console.log(ui.item.value); // not in your question, but might help later
                }
            });
        })
    </script>
    <script>
        $(function () {
            $("#search_term").autocomplete({
                source: function (request, response) {
                    var url = ''
                    var value = $('#tables').val()
                    var length = 2
                    if (value == "Genes")
                    {
                        url = "{{url_for('autocomplete')}}"
                    }
                    else if (value == "Transcripts")
                    {
                        url = "{{url_for('autocomplete_tx')}}"
                        length = 5
                    }
                    else if (value == "Panels")
                    {
                        url = "{{url_for('autocomplete_panel')}}"
                    }
                    else if (value == "VPanels")
                    {
                        url = "{{url_for('autocomplete_vp')}}"
                    }
                    else if (value == "Projects")
                    {
                        url = "{{url_for('autocomplete_project')}}"
                    }
                    else if (value == "Users")
                    {
                        url = "{{url_for('autocomplete_user')}}"
                    }
                    console.log(url)
                    console.log(value)
                    $.getJSON(url, {
                        q: request.term, // in flask, "q" will be the argument to look for using request.args
                    }, function (data) {
                        response(data.matching_results); // matching_results from jsonify
                    });
                },
                minLength: length,
                select: function (event, ui) {
                    console.log(ui.item.value); // not in your question, but might help later
                }
            });
        })
    </script>

    {% if delete == True %}
    <script type="text/javascript">
        $(document).ready(function () {

            $('#areyousure').modal('show');

        });
    </script>
    {% endif %}
</head>


<body>


<nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                    aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button><!---->
            <a class="navbar-brand" href="{{ url_for('index') }}"><span class="glyphicon glyphicon-th-list"></span>
                PanelPal</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
                <li><a href="{{ url_for('index') }}">Home</a></li>
                <li><a href="{{ url_for('search_for') }}">Search</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                       aria-expanded="false">Projects <span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        <li><a href="{{ url_for('view_projects') }}">View Projects</a></li>
                        <li role="separator" class="divider"></li>
                        <li><a href="{{ url_for('add_projects') }}">Create Project</a></li>
                    </ul>
                </li>


                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                       aria-expanded="false">Panels <span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        <li><a href="{{ url_for('view_panels') }}">View Panels</a></li>
                        <li role="separator" class="divider"></li>
                        <li><a href="/panels/create">Create Panel</a></li>
                        <!--<li><a href="#">Create Panel From Panel App</a></li>-->
                        <!--<li role="separator" class="divider"></li>-->
                        <!--<li><a href="#">Export Panel</a></li>-->
                    </ul>
                </li>

                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                       aria-expanded="false">Virtual Panels <span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        <li><a href="/virtualpanels">View Virtual Panels</a></li>
                        <li role="separator" class="divider"></li>
                        <li><a href="/virtualpanels/wizard">Create a Virtual Panel</a></li>
                        <!--<li role="separator" class="divider"></li>-->
                        <!--<li><a href="#">Export Virtual Panel</a></li>-->
                    </ul>
                </li>
                {% if admin == True %}
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                       aria-expanded="false">Admin <span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        <li><a href="/admin/user">User Admin</a></li>
                        <li role="separator" class="divider"></li>
                        <li><a href="/edit_permissions_admin">Permissions</a></li>
                        <!--<li role="separator" class="divider"></li>-->
                        <!--<li><a href="/virtualpanels/create">Create a Virtual Panel</a></li>-->
                        <!--<li role="separator" class="divider"></li>-->
                        <!--<li><a href="#">Export Virtual Panel</a></li>-->
                    </ul>
                </li>
                {% endif %}
                <!--<li class="dropdown">-->
                    <!--<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"-->
                       <!--aria-expanded="false">Preferred TX <span class="caret"></span></a>-->
                    <!--<ul class="dropdown-menu">-->
                        <!--<li><a href="">View Transcripts</a>-->
                        <!--<li role="separator" class="divider"></li>-->
                    <!--</ul>-->
                <!--</li>-->

                <!--<li class="dropdown">-->
                    <!--<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"-->
                       <!--aria-expanded="false">Polylists<span class="caret"></span></a>-->
                    <!--<ul class="dropdown-menu">-->
                        <!--<li><a href="">View Transcripts</a>-->
                        <!--<li role="separator" class="divider"></li>-->
                    <!--</ul>-->
                <!--</li>-->


                <li><a href="/api/spec.html"><span class="glyphicon glyphicon-cog"></span> API</a></li>
            </ul>

            <form class="navbar-form navbar-right" role="search">
                {% if logged_in == True %}
                    {% if admin == True %}
                        <a href="{{ url_for('logout')}}" class="btn btn-success" role="button">Logout <strong>{{ userid
                            }} </strong> </a>
                    {% else %}
                    <a href="{{ url_for('logout')}}" class="btn btn-success" role="button">Logout <strong>{{ userid
                                }}</strong></a>
                    {% endif %}
                {% else %}
                <a href="{{ url_for('login')}}" class="btn btn-primary" role="button">Login</a>
                {% endif %}
            </form>
            <!--<form class="navbar-form navbar-right" role="search">-->
  <!--<div class="form-group">-->
    <!--<input type="text" class="form-control" placeholder="Search">-->
  <!--</div>-->
  <!--<button type="submit" class="btn btn-default">Submit</button>-->
<!--</form>-->
        </div><!--/.nav-collapse -->
    </div>
</nav>

{% block popup %}
{% endblock %}

<div class="container theme-showcase" role="main">
    <div class="container">
        {% block content %}
        {% endblock %}
    </div>
</div>


</body>
</html>